<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BATTLE TRAINING PRO</title>

<!-- æˆªåœ–ç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- åœ–è¡¨ç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  body{margin:0;background:radial-gradient(circle at top,#3a0ca3,#000);font-family:Arial,sans-serif;color:#fff;min-height:100vh}
  .container{max-width:980px;margin:auto;padding:16px;text-align:center}
  h1{letter-spacing:3px;color:#00f5ff;text-shadow:0 0 12px #00f5ff;margin:10px 0 6px}
  .sub{font-size:13px;color:#cfcfcf;line-height:1.45;margin-bottom:10px}
  .panel{text-align:left;background:rgba(0,0,0,.55);border:1px solid rgba(0,245,255,.25);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 0 18px rgba(0,245,255,.12)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:14px 16px;border:none;border-radius:14px;font-weight:900;cursor:pointer}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .primary{background:linear-gradient(135deg,#ff00c8,#00f5ff);color:#000;box-shadow:0 0 14px rgba(255,0,200,.25)}
  .secondary{background:linear-gradient(135deg,#00f5ff,#ffe600);color:#000}
  .ghost{background:linear-gradient(135deg,rgba(255,0,200,.18),rgba(0,245,255,.18));color:#fff;border:1px solid rgba(255,255,255,.16)}
  .danger{background:linear-gradient(135deg,#ff3b3b,#ff00c8);color:#000}
  input,select{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);color:#fff;outline:none}
  select{min-width:260px}
  .muted{color:#bfbfbf}
  .ok{color:#00f5ff;font-weight:900}
  .bad{color:#ff6b6b;font-weight:900}
  .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
  .pill{padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);font-size:14px;line-height:1.35;margin-top:8px}
  .pill b{color:#00f5ff}

  /* Cards */
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:12px}
  .card{perspective:1000px}
  .card-inner{position:relative;width:100%;padding-top:135%;transition:transform .8s;transform-style:preserve-3d}
  .card.flip .card-inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:18px;backface-visibility:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:14px;font-weight:900;text-align:center}
  .back{background:linear-gradient(135deg,#111,#333);border:2px solid #00f5ff;font-size:22px;letter-spacing:2px}
  .front{background:linear-gradient(135deg,#ff00c8,#3a0ca3);transform:rotateY(180deg)}
  .round{font-size:14px;color:#ffe600;margin-bottom:6px}
  .move{font-size:20px;color:#00f5ff;margin-bottom:6px}
  .rule{font-size:16px;color:#fff}

  /* Ratings */
  .ratingGrid{display:grid;gap:10px;margin-top:10px}
  .ratingRow{display:grid;grid-template-columns:120px 1fr 44px;gap:10px;align-items:center}
  .ratingRow label{font-weight:900;color:#00f5ff;font-size:13px}
  .ratingRow input[type="range"]{width:100%}
  .scoreBox{text-align:center;padding:8px 6px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);font-weight:900}

  /* History */
  details{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:14px;padding:10px 10px}
  summary{cursor:pointer;font-weight:900;color:#00f5ff;outline:none}
  .histList{display:grid;gap:10px;margin-top:10px}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr;} }
  canvas{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px}
</style>
</head>

<body>
<div class="container">
  <h1>BATTLE TRAINING</h1>
  <div class="sub">
    æµç¨‹ï¼šæŠ½é¡Œé è¦½ â†’ ç·´å®Œè©•åˆ† â†’ ç¢ºèªç´€éŒ„ï¼ˆé›²ç«¯å­˜æª”ï¼‰ï½œæŠ½é¡Œæœƒé¿é–‹ã€Œä¸Šä¸€ç­†ç¢ºèªã€æ•´çµ„å…§å®¹ä¸é‡è¤‡
  </div>

  <!-- LOGIN -->
  <div class="panel">
    <div class="row">
      <div id="loginState">å°šæœªç™»å…¥</div>
      <div id="roleState" class="muted"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="btnLogin">Google ç™»å…¥</button>
      <button class="btn ghost" id="btnLogout">ç™»å‡º</button>
    </div>
    <div id="gateMsg" class="bad" style="margin-top:10px;"></div>
    <div id="debugMsg" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- APP -->
  <div id="appPanel" class="panel" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="ok">âœ… ä½ åœ¨å…è¨±åå–®å…§</div>
        <div class="muted" id="userTip"></div>
      </div>
      <button class="btn ghost" id="btnShot" disabled>ğŸ“¸ åŒ¯å‡ºåœ–ç‰‡</button>
    </div>

    <div class="divider"></div>

    <div class="row" style="justify-content:center;">
      <button class="btn primary" id="btnStart">ğŸš€ æŠ½è¨“ç·´é¡Œç›®ï¼ˆé è¦½ï¼‰</button>
      <button class="btn ghost" id="btnReroll" disabled>ğŸ² é‡æŠ½ï¼ˆé è¦½ï¼‰</button>
      <button class="btn secondary" id="btnConfirm" disabled>âœ… ç¢ºèªç´€éŒ„ï¼ˆé›²ç«¯ï¼‰</button>
    </div>

    <!-- Share Area -->
    <div id="shareArea">
      <div class="pill">
        <span class="muted">åˆ†äº«æŠ¬é ­ï¼š</span>
        <b id="shareTitle">â€”</b>
        <div class="muted" id="shareTime">â€”</div>
      </div>

      <div id="cards" class="cards"></div>

      <div class="divider"></div>

      <div style="font-weight:900;color:#ffe600;margin-bottom:6px;">è¨“ç·´è©•åˆ†ï¼ˆ1~5ï¼‰</div>
      <div class="ratingGrid">
        <div class="ratingRow"><label>éŸ³æ¨‚æ€§</label><input id="r_music" type="range" min="1" max="5" value="3"><div class="scoreBox" id="s_music">3</div></div>
        <div class="ratingRow"><label>è³ªåœ°</label><input id="r_texture" type="range" min="1" max="5" value="3"><div class="scoreBox" id="s_texture">3</div></div>
        <div class="ratingRow"><label>é€Ÿåº¦å·®</label><input id="r_speed" type="range" min="1" max="5" value="3"><div class="scoreBox" id="s_speed">3</div></div>
        <div class="ratingRow"><label>ä¿æŒç§»å‹•</label><input id="r_move" type="range" min="1" max="5" value="3"><div class="scoreBox" id="s_move">3</div></div>
        <div class="ratingRow"><label>æ•´é«”</label><input id="r_overall" type="range" min="1" max="5" value="3"><div class="scoreBox" id="s_overall">3</div></div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- My History + Charts -->
    <details open>
      <summary>ğŸ“š æˆ‘çš„é›²ç«¯æ­·å²ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰ï¼‹çµ±è¨ˆ</summary>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <div class="pill"><b>æœ€è¿‘ 10 ç­†</b><div class="muted">ï¼ˆåªè¨˜éŒ„ä½ æŒ‰ã€Œç¢ºèªç´€éŒ„ã€çš„å…§å®¹ï¼‰</div></div>
          <div id="myHistory" class="histList"></div>
        </div>
        <div>
          <div class="pill"><b>è©•åˆ†çµ±è¨ˆ</b><div class="muted">æŠ˜ç·šï¼æ•´é«”åˆ†ï½œé•·æ¢ï¼å„é¢å‘å¹³å‡</div></div>
          <canvas id="chartLine" height="220"></canvas>
          <div style="height:12px;"></div>
          <canvas id="chartBar" height="220"></canvas>
        </div>
      </div>
    </details>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" class="panel" style="display:none;">
    <div class="ok">ğŸ›¡ï¸ æ•™ç·´å¾Œå°ï¼šåå–®ç®¡ç†ï¼‹æŸ¥çœ‹å­¸ç”Ÿç´€éŒ„ï¼‹çµ±è¨ˆ</div>

    <div class="divider"></div>

    <div class="row">
      <input id="addEmail" placeholder="æ–°å¢å…è¨±é¸æ‰‹ emailï¼ˆä¾‹ï¼šdancer@gmail.comï¼‰" />
      <button class="btn secondary" id="btnAdd">æ–°å¢</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="removeEmail" placeholder="ç§»é™¤/åœæ¬Šé¸æ‰‹ email" />
      <button class="btn danger" id="btnRemove">ç§»é™¤</button>
    </div>
    <div id="adminMsg" class="muted" style="margin-top:10px;"></div>

    <div class="divider"></div>

    <div class="row">
      <select id="studentSelect">
        <option value="">ï¼ˆé¸æ“‡å­¸ç”Ÿï¼‰</option>
      </select>
      <button class="btn ghost" id="btnLoadStudent">è¼‰å…¥å­¸ç”Ÿè³‡æ–™</button>
    </div>

    <div id="studentArea" style="display:none;">
      <div class="pill">
        <span class="muted">å­¸ç”Ÿï¼š</span><b id="studentTitle">â€”</b>
        <div class="muted" id="studentMeta">â€”</div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <div class="pill"><b>å­¸ç”Ÿæœ€è¿‘ 10 ç­†</b></div>
          <div id="studentHistory" class="histList"></div>
        </div>
        <div>
          <div class="pill"><b>å­¸ç”Ÿè©•åˆ†çµ±è¨ˆ</b></div>
          <canvas id="chartLineStu" height="220"></canvas>
          <div style="height:12px;"></div>
          <canvas id="chartBarStu" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider,
    signInWithPopup, signInWithRedirect, getRedirectResult,
    signOut, onAuthStateChanged, setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, addDoc, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // =========================
  // 0) ä½ è¦æ³¨æ„çš„ã€Œå…©å€‹é›†åˆåç¨±ã€
  // =========================
  // å…è¨±åå–®é›†åˆï¼šæ¯å€‹ docId = email
  // ä½ åŸæœ¬ç•«é¢å«ã€Œéœ¹é‚èˆã€ï¼Œæˆ‘å°±æ²¿ç”¨ï¼ˆä¸è¦æ”¹ï¼Œå…å¾—ä½ å†æ‰¾ä¸åˆ°ï¼‰
  const ALLOWLIST_COL = "éœ¹é‚èˆ";

  // æ•™ç·´åå–®é›†åˆï¼šæ¯å€‹ docId = emailï¼Œæ¬„ä½ role: "coach"
  // ä½ å¯ä»¥æ”¹æˆä½ æƒ³è¦çš„åå­—ï¼Œä½†è¦è·Ÿ Firestore ä¸€è‡´
  const COACH_COL = "coaches";

  // ç´€éŒ„ï¼šrecords/{email}/items/{autoId} + records/{email}/meta (å­˜ lastSig)
  const RECORDS_ROOT = "records";

  // =========================
  // 1) Firebase Configï¼ˆä½ çš„ï¼‰
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyDqwvRJEEPPvT0-PUY9bTTwbikD9mI21XQ",
    authDomain: "breaking-814bf.firebaseapp.com",
    projectId: "breaking-814bf",
    storageBucket: "breaking-814bf.firebasestorage.app",
    messagingSenderId: "1061448738181",
    appId: "1:1061448738181:web:29ce05df24b74bdf15d0ec",
    measurementId: "G-7KD2654Y69"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // =========================
  // 2) DOM
  // =========================
  const $ = (id) => document.getElementById(id);

  const btnLogin   = $("btnLogin");
  const btnLogout  = $("btnLogout");

  const loginState = $("loginState");
  const roleState  = $("roleState");
  const gateMsg    = $("gateMsg");
  const debugMsg   = $("debugMsg");

  const appPanel   = $("appPanel");
  const adminPanel = $("adminPanel");

  const btnShot    = $("btnShot");
  const btnStart   = $("btnStart");
  const btnReroll  = $("btnReroll");
  const btnConfirm = $("btnConfirm");

  const shareTitle = $("shareTitle");
  const shareTime  = $("shareTime");
  const cardsBox   = $("cards");
  const userTip    = $("userTip");

  const myHistory  = $("myHistory");
  const chartLineEl= $("chartLine");
  const chartBarEl = $("chartBar");

  const addEmail   = $("addEmail");
  const removeEmail= $("removeEmail");
  const btnAdd     = $("btnAdd");
  const btnRemove  = $("btnRemove");
  const adminMsg   = $("adminMsg");

  const studentSelect = $("studentSelect");
  const btnLoadStudent= $("btnLoadStudent");
  const studentArea   = $("studentArea");
  const studentTitle  = $("studentTitle");
  const studentMeta   = $("studentMeta");
  const studentHistory= $("studentHistory");
  const chartLineStuEl= $("chartLineStu");
  const chartBarStuEl = $("chartBarStu");

  // =========================
  // 3) Authï¼šiOS Safari ç”¨ Redirect æœ€ç©©
  // =========================
  const provider = new GoogleAuthProvider();
  const ua = navigator.userAgent || "";
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

  await setPersistence(auth, browserLocalPersistence);

  // æ¥ redirect å›ä¾†çš„çµæœï¼ˆå¿…åšï¼‰
  try { await getRedirectResult(auth); }
  catch (e) {
    // æ²’æœ‰çµæœä¹Ÿå¯èƒ½æœƒé€²ä¾†ï¼›é¡¯ç¤ºéŒ¯èª¤ç¢¼æ‰å¥½æŸ¥
    debugMsg.textContent = e?.code ? `redirect: ${e.code}` : "";
  }

  async function doLogin(){
    debugMsg.textContent = "";
    // iOS Safariï¼šç›´æ¥ redirect
    if (isIOS && isSafari){
      await signInWithRedirect(auth, provider);
      return;
    }
    // å…¶ä»–ï¼šå…ˆ popupï¼Œå¤±æ•— fallback redirect
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      debugMsg.textContent = e?.code ? `popup: ${e.code} â†’ æ”¹ç”¨ redirect` : "popup å¤±æ•— â†’ æ”¹ç”¨ redirect";
      await signInWithRedirect(auth, provider);
    }
  }

  async function doLogout(){
    debugMsg.textContent = "";
    await signOut(auth);
  }

  btnLogin.addEventListener("click", doLogin);
  btnLogout.addEventListener("click", doLogout);

  // =========================
  // 4) æŠ½é¡Œè³‡æ–™
  // =========================
  const fixedRounds = ["Top Rock","Go Down","Footwork","Set"];
  const pool = {
    "Top Rock": ["Rock åŸºæœ¬å¾‹å‹•", "æ–¹å‘è®ŠåŒ–", "å±¤æ¬¡åˆ‡æ›", "ç¯€å¥æ–·é»", "æ‰‹è‡‚ç·šæ¢"],
    "Go Down":  ["ä¹¾æ·¨è½åœ°", "æ§åˆ¶é‡å¿ƒ", "çªç„¶ä¸‹é™", "åœ°æ¿åˆ‡å…¥", "å‡å‹•ä½œè½åœ°"],
    "Footwork": ["ç¯€å¥è…³æ­¥", "è§’åº¦è½‰æ›", "è¿‘èº«æ»‘å‹•", "åŠ é€Ÿçˆ†é»", "é€£æ¥æµæš¢"],
    "Set":      ["Freeze å®šé»", "Power é€£æ¥", "å‡ power", "è§’åº¦ pose", "å‘¼å¸åœé “"]
  };
  const rules = ["éŸ³æ¨‚è¡¨ç¾","è³ªåœ°å‘ˆç¾","é€Ÿåº¦å·®å‘ˆç¾","ä¿æŒç§»å‹•","ç©ºé–“é‹ç”¨","è§’åº¦è®ŠåŒ–","å‘¼å¸æ§åˆ¶","ä¹¾æ·¨åº¦"];

  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function nowText(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

  // =========================
  // 5) ç‹€æ…‹
  // =========================
  let currentUser = null;
  let isAllowed = false;
  let isCoach = false;

  let preview = null; // {ts, cards:[{round,move,rule}], sig}
  let chartLine = null, chartBar = null;
  let chartLineStu = null, chartBarStu = null;

  // =========================
  // 6) Firestore è·¯å¾‘ helpers
  // =========================
  function allowDoc(email){
    return doc(db, ALLOWLIST_COL, email);
  }
  function coachDoc(email){
    return doc(db, COACH_COL, email);
  }
  function recordsMetaDoc(email){
    return doc(db, RECORDS_ROOT, email, "meta", "state");
  }
  function recordsItemsCol(email){
    return collection(db, RECORDS_ROOT, email, "items");
  }

  // =========================
  // 7) Gateï¼šæª¢æŸ¥å…è¨±åå–® + æ•™ç·´è§’è‰²
  // =========================
  async function checkGate(user){
    gateMsg.textContent = "";
    roleState.textContent = "";

    if(!user?.email){
      isAllowed = false;
      isCoach = false;
      return;
    }

    const email = user.email.toLowerCase();

    // å…è¨±åå–®
    const aSnap = await getDoc(allowDoc(email));
    isAllowed = aSnap.exists();

    // æ•™ç·´åå–®ï¼ˆå¯é¸ï¼‰
    const cSnap = await getDoc(coachDoc(email));
    isCoach = cSnap.exists() && (cSnap.data()?.role === "coach");

    if(isCoach) roleState.textContent = "ï¼ˆæ•™ç·´ï¼‰";
  }

  // =========================
  // 8) UI æ§åˆ¶
  // =========================
  function setUI(){
    if(!currentUser){
      loginState.textContent = "å°šæœªç™»å…¥";
      appPanel.style.display = "none";
      adminPanel.style.display = "none";
      gateMsg.textContent = "";
      return;
    }

    loginState.textContent = `å·²ç™»å…¥ï¼š${currentUser.email || ""}`;

    if(!isAllowed){
      appPanel.style.display = "none";
      adminPanel.style.display = "none";
      gateMsg.textContent = "ä½ ä¸åœ¨å…è¨±åå–®å…§ï¼ˆè«‹æ•™ç·´æŠŠä½ çš„ email åŠ å…¥åå–®ï¼‰";
      return;
    }

    gateMsg.textContent = "";
    appPanel.style.display = "block";
    userTip.textContent = `ä½¿ç”¨è€…ï¼š${currentUser.email}`;

    // æ•™ç·´æ‰é¡¯ç¤ºå¾Œå°
    adminPanel.style.display = isCoach ? "block" : "none";
  }

  // =========================
  // 9) ç”¢ç”Ÿé è¦½ï¼ˆé¿é–‹ä¸Šä¸€ç­†ç¢ºèªï¼‰
  // =========================
  function signature(cards){
    // ç”¨ round|move|rule çµ„åˆæˆå”¯ä¸€ç°½å
    return cards.map(c => `${c.round}|${c.move}|${c.rule}`).join("||");
  }

  async function getLastSig(email){
    const snap = await getDoc(recordsMetaDoc(email));
    return snap.exists() ? (snap.data()?.lastSig || "") : "";
  }

  async function setLastSig(email, sig){
    await setDoc(recordsMetaDoc(email), { lastSig: sig }, { merge:true });
  }

  function renderCards(cards){
    cardsBox.innerHTML = "";
    cards.forEach((c, idx) => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="card-inner">
          <div class="face back">CLICK</div>
          <div class="face front">
            <div class="round">Round ${idx+1} Â· ${c.round}</div>
            <div class="move">${c.move}</div>
            <div class="rule">è¦å‰‡ï¼š${c.rule}</div>
          </div>
        </div>
      `;
      el.addEventListener("click", () => el.classList.toggle("flip"));
      cardsBox.appendChild(el);
    });
  }

  function getRatings(){
    const v = (id) => Number($(id).value);
    return {
      music: v("r_music"),
      texture: v("r_texture"),
      speed: v("r_speed"),
      move: v("r_move"),
      overall: v("r_overall")
    };
  }

  function bindRanges(){
    const bind = (rid, sid) => {
      const r = $(rid), s = $(sid);
      const fn = () => s.textContent = String(r.value);
      r.addEventListener("input", fn);
      fn();
    };
    bind("r_music","s_music");
    bind("r_texture","s_texture");
    bind("r_speed","s_speed");
    bind("r_move","s_move");
    bind("r_overall","s_overall");
  }
  bindRanges();

  async function makePreview(){
    if(!currentUser?.email) return;

    const email = currentUser.email.toLowerCase();
    const lastSig = await getLastSig(email);

    let tries = 0;
    let cards = null;
    let sig = "";

    while(tries < 12){
      tries++;

      // å›ºå®šå››è¼ªï¼Œæ¯è¼ªæŠ½ move + rule
      const cardsTry = fixedRounds.map((round, i) => {
        const move = shuffle(pool[round])[0];
        const rule = shuffle(rules)[0];
        return { round, move, rule };
      });

      sig = signature(cardsTry);
      if(sig !== lastSig){
        cards = cardsTry;
        break;
      }
    }

    if(!cards){
      // çœŸçš„å¾ˆè¡°æ‰æœƒåˆ°é€™è£¡ï¼ˆå¹¾ä¹ä¸æœƒï¼‰
      cards = fixedRounds.map((round) => ({
        round,
        move: shuffle(pool[round])[0],
        rule: shuffle(rules)[0]
      }));
      sig = signature(cards);
    }

    const ts = Date.now();
    preview = { ts, cards, sig };

    shareTitle.textContent = `BATTLE TRAINING Â· ${currentUser.email}`;
    shareTime.textContent = `é è¦½æ™‚é–“ï¼š${nowText(ts)}`;

    renderCards(cards);

    btnReroll.disabled = false;
    btnConfirm.disabled = false;
    btnShot.disabled = false;
  }

  // =========================
  // 10) å­˜é›²ç«¯ï¼ˆç¢ºèªç´€éŒ„ï¼‰
  // =========================
  async function confirmRecord(){
    if(!currentUser?.email || !preview) return;

    btnConfirm.disabled = true;

    const email = currentUser.email.toLowerCase();
    const ts = Date.now();
    const ratings = getRatings();

    const docData = {
      ts,
      email,
      cards: preview.cards,
      sig: preview.sig,
      ratings
    };

    await addDoc(recordsItemsCol(email), docData);
    await setLastSig(email, preview.sig);

    shareTime.textContent = `âœ… å·²ç¢ºèªï¼š${nowText(ts)}`;

    // æ›´æ–°æˆ‘çš„æ­·å²/åœ–è¡¨
    await loadMyHistory();

    btnConfirm.disabled = false;
  }

  // =========================
  // 11) è®€å–æ­·å² + ç•«åœ–
  // =========================
  function renderHistory(listEl, items){
    listEl.innerHTML = "";
    if(items.length === 0){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `<div class="muted">å°šç„¡ç´€éŒ„</div>`;
      listEl.appendChild(div);
      return;
    }

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "pill";
      const r = it.ratings || {};
      div.innerHTML = `
        <b>${new Date(it.ts).toLocaleString()}</b>
        <div class="muted">æ•´é«”ï¼š${r.overall ?? "-"}ï½œéŸ³æ¨‚ï¼š${r.music ?? "-"}ï½œè³ªåœ°ï¼š${r.texture ?? "-"}ï½œé€Ÿåº¦å·®ï¼š${r.speed ?? "-"}ï½œä¿æŒç§»å‹•ï¼š${r.move ?? "-"}</div>
      `;
      listEl.appendChild(div);
    });
  }

  function avg(items, key){
    if(items.length === 0) return 0;
    const s = items.reduce((acc, it) => acc + Number(it.ratings?.[key] || 0), 0);
    return s / items.length;
  }

  function drawCharts(lineCanvas, barCanvas, items, holder){
    const labels = items.map(it => new Date(it.ts).toLocaleDateString());
    const overall = items.map(it => Number(it.ratings?.overall || 0));

    const barLabels = ["éŸ³æ¨‚æ€§","è³ªåœ°","é€Ÿåº¦å·®","ä¿æŒç§»å‹•","æ•´é«”"];
    const barData = [
      avg(items,"music"),
      avg(items,"texture"),
      avg(items,"speed"),
      avg(items,"move"),
      avg(items,"overall")
    ];

    // æ¸…æ‰èˆŠçš„ chart
    if(holder.line) holder.line.destroy();
    if(holder.bar) holder.bar.destroy();

    holder.line = new Chart(lineCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [{ label:"æ•´é«”åˆ†", data: overall }]
      },
      options: {
        responsive:true,
        scales: { y: { min:0, max:5, ticks:{ stepSize:1 } } }
      }
    });

    holder.bar = new Chart(barCanvas, {
      type: "bar",
      data: {
        labels: barLabels,
        datasets: [{ label:"å¹³å‡åˆ†", data: barData }]
      },
      options: {
        responsive:true,
        scales: { y: { min:0, max:5, ticks:{ stepSize:1 } } }
      }
    });
  }

  async function loadHistory(email){
    const q = query(recordsItemsCol(email), orderBy("ts","desc"), limit(10));
    const snap = await getDocs(q);
    const items = [];
    snap.forEach(d => items.push(d.data()));
    return items;
  }

  async function loadMyHistory(){
    if(!currentUser?.email) return;
    const email = currentUser.email.toLowerCase();
    const items = await loadHistory(email);

    renderHistory(myHistory, items);

    // chart ç”¨æ™‚é–“é †ï¼ˆèˆŠâ†’æ–°ï¼‰æ¯”è¼ƒå¥½çœ‹
    const ordered = [...items].reverse();
    drawCharts(chartLineEl, chartBarEl, ordered, { get line(){return chartLine}, set line(v){chartLine=v}, get bar(){return chartBar}, set bar(v){chartBar=v} });
  }

  // =========================
  // 12) æ•™ç·´å¾Œå°ï¼šåå–®ç®¡ç† + å­¸ç”Ÿè³‡æ–™
  // =========================
  async function refreshStudentSelect(){
    if(!isCoach) return;
    studentSelect.innerHTML = `<option value="">ï¼ˆé¸æ“‡å­¸ç”Ÿï¼‰</option>`;

    const snap = await getDocs(collection(db, ALLOWLIST_COL));
    const emails = [];
    snap.forEach(d => {
      const id = (d.id || "").toLowerCase();
      if(id) emails.push(id);
    });

    emails.sort();
    emails.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e;
      opt.textContent = e;
      studentSelect.appendChild(opt);
    });
  }

  async function adminAdd(){
    if(!isCoach) return;
    const email = (addEmail.value || "").trim().toLowerCase();
    if(!email.includes("@")){
      adminMsg.textContent = "è«‹è¼¸å…¥æ­£ç¢º email";
      return;
    }
    await setDoc(allowDoc(email), { role:"student", updatedAt: Date.now() }, { merge:true });
    adminMsg.textContent = `âœ… å·²æ–°å¢ï¼š${email}`;
    addEmail.value = "";
    await refreshStudentSelect();
  }

  async function adminRemove(){
    if(!isCoach) return;
    const email = (removeEmail.value || "").trim().toLowerCase();
    if(!email.includes("@")){
      adminMsg.textContent = "è«‹è¼¸å…¥æ­£ç¢º email";
      return;
    }
    await deleteDoc(allowDoc(email));
    adminMsg.textContent = `ğŸ—‘ï¸ å·²ç§»é™¤ï¼š${email}`;
    removeEmail.value = "";
    await refreshStudentSelect();
  }

  async function loadStudent(){
    if(!isCoach) return;
    const email = (studentSelect.value || "").trim().toLowerCase();
    if(!email){
      adminMsg.textContent = "è«‹å…ˆé¸å­¸ç”Ÿ";
      return;
    }

    const items = await loadHistory(email);
    studentArea.style.display = "block";
    studentTitle.textContent = email;
    studentMeta.textContent = `æœ€è¿‘ ${items.length} ç­†ï¼ˆåªåŒ…å«ç¢ºèªç´€éŒ„ï¼‰`;

    renderHistory(studentHistory, items);

    const ordered = [...items].reverse();
    drawCharts(chartLineStuEl, chartBarStuEl, ordered, { get line(){return chartLineStu}, set line(v){chartLineStu=v}, get bar(){return chartBarStu}, set bar(v){chartBarStu=v} });
  }

  btnAdd.addEventListener("click", adminAdd);
  btnRemove.addEventListener("click", adminRemove);
  btnLoadStudent.addEventListener("click", loadStudent);

  // =========================
  // 13) åŒ¯å‡ºåœ–ç‰‡
  // =========================
  async function exportImage(){
    const area = $("shareArea");
    btnShot.disabled = true;

    const canvas = await html2canvas(area, { backgroundColor: null, scale: 2 });
    const a = document.createElement("a");
    a.download = `battle_training_${Date.now()}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();

    btnShot.disabled = false;
  }
  btnShot.addEventListener("click", exportImage);

  // =========================
  // 14) äº‹ä»¶ï¼šæŠ½é¡Œ/é‡æŠ½/ç¢ºèª
  // =========================
  btnStart.addEventListener("click", async () => {
    await makePreview();
  });

  btnReroll.addEventListener("click", async () => {
    await makePreview();
  });

  btnConfirm.addEventListener("click", async () => {
    await confirmRecord();
  });

  // =========================
  // 15) Auth ç‹€æ…‹ç›£è½ï¼ˆæ ¸å¿ƒï¼‰
  // =========================
  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;

    // reset
    preview = null;
    cardsBox.innerHTML = "";
    btnReroll.disabled = true;
    btnConfirm.disabled = true;
    btnShot.disabled = true;
    shareTitle.textContent = "â€”";
    shareTime.textContent = "â€”";
    gateMsg.textContent = "";
    roleState.textContent = "";

    if(!currentUser){
      isAllowed = false;
      isCoach = false;
      setUI();
      return;
    }

    try{
      await checkGate(currentUser);
      setUI();

      // å…è¨±è€…ï¼šè¼‰å…¥æˆ‘çš„æ­·å²
      if(isAllowed){
        await loadMyHistory();
      }

      // æ•™ç·´ï¼šåˆ·æ–°å­¸ç”Ÿæ¸…å–®
      if(isCoach){
        await refreshStudentSelect();
      }
    }catch(e){
      debugMsg.textContent = e?.code ? `gate: ${e.code}` : "è®€å–æ¬Šé™/è³‡æ–™ç™¼ç”ŸéŒ¯èª¤";
      // é€™è£¡é€šå¸¸æ˜¯ rules æ“‹ä½
      isAllowed = false;
      isCoach = false;
      setUI();
    }
  });

</script>
</body>
</html>
